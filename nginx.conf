upstream rails_app {
  server rails:3000;
}

server {
  listen 80;
  server_name localhost;

  location = / {
    return 301 /e-newspaper/;
  }

  location /e-newspaper/ {
    # Remove /e-newspaper prefix before proxying to Rails
    rewrite ^/e-newspaper/(.*)$ /$1 break;

    proxy_pass http://rails_app;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # Force HTTPS protocol since the site is accessed via HTTPS
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port 443;

    # Force HTTPS for asset URLs
    proxy_set_header X-Forwarded-Ssl on;

    # WebSocket support
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Increase timeouts for long-running requests
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
  }

  # Handle /e-newspaper prefixed requests by stripping the prefix
  location /e-newspaper/up {
    # Remove /e-newspaper prefix before proxying to Rails
    rewrite ^/e-newspaper/(.*)$ /$1 break;

    proxy_pass http://rails_app/up;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # Force HTTPS protocol since the site is accessed via HTTPS
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port 443;

    # Force HTTPS for asset URLs
    proxy_set_header X-Forwarded-Ssl on;

    # WebSocket support
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Increase timeouts for long-running requests
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
  }

  # Handle root level requests (for pages)
  # location / {
  #   proxy_pass http://rails_app/;
  #   proxy_set_header Host $host;
  #   proxy_set_header X-Real-IP $remote_addr;
  #   proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  #   proxy_set_header X-Forwarded-Proto $scheme;
  #   proxy_set_header X-Forwarded-Host $host;
  #   proxy_set_header X-Forwarded-Port $server_port;

  #   # Set the script name for Rails to generate correct asset paths
  #   proxy_set_header X-Forwarded-Script-Name /e-newspaper;

  #   # WebSocket support
  #   proxy_http_version 1.1;
  #   proxy_set_header Upgrade $http_upgrade;
  #   proxy_set_header Connection "upgrade";

  #   # Increase timeouts for long-running requests
  #   proxy_connect_timeout 60s;
  #   proxy_send_timeout 60s;
  #   proxy_read_timeout 60s;
  # }
}